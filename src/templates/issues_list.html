{% extends "base.html" %}

{% block title %}Issue Log{% endblock %}

{% block content %}
<section class="card">
    <div class="page-header">
        <div>
            <h1 class="page-title">Issue Tracking Log</h1>
            <p class="subtitle">Track and manage all reported issues</p>
        </div>
        <a class="btn" href="{{ url_for('issues.report_issue') }}">Report New Issue</a>
    </div>

    <!-- Filters & Sort -->
    <form method="GET" action="{{ url_for('issues.list_issues') }}" class="filters-form">
        <div class="filters-grid">
            <!-- Status Filter -->
            <div class="filter-item">
                <label for="status">Status:</label>
                <select name="status" id="status" onchange="this.form.submit()">
                    <option value="all" {% if not current_status or current_status == 'all' %}selected{% endif %}>All Statuses</option>
                    <option value="New" {% if current_status == 'New' %}selected{% endif %}>New</option>
                    <option value="In Progress" {% if current_status == 'In Progress' %}selected{% endif %}>In Progress</option>
                    <option value="Resolved" {% if current_status == 'Resolved' %}selected{% endif %}>Resolved</option>
                </select>
            </div>

            <!-- Room Filter -->
            <div class="filter-item">
                <label for="room_id">Room:</label>
                <select name="room_id" id="room_id" onchange="this.form.submit()">
                    <option value="">All Rooms</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}" 
                            {% if current_room and current_room|int == room.id %}selected{% endif %}>
                        {{ room.building }} {{ room.number }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Assigned Filter -->
            <div class="filter-item">
                <label for="assigned_to">Assigned To:</label>
                <select name="assigned_to" id="assigned_to" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="unassigned" 
                            {% if current_assigned == 'unassigned' %}selected{% endif %}>
                        Unassigned
                    </option>
                    {% for user in users %}
                    <option value="{{ user.id }}" 
                            {% if current_assigned and current_assigned|int == user.id %}selected{% endif %}>
                        {{ user.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Sort -->
            <div class="filter-item">
                <label for="sort">Sort By:</label>
                <select name="sort" id="sort" onchange="this.form.submit()">
                    <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Date (Newest)</option>
                    <option value="priority" {% if current_sort == 'priority' %}selected{% endif %}>Priority</option>
                    <option value="status" {% if current_sort == 'status' %}selected{% endif %}>Status</option>
                </select>
            </div>
        </div>

        <div class="actions-row">
            <a href="{{ url_for('issues.list_issues') }}" class="btn secondary small">Clear Filters</a>
        </div>
    </form>
</section>

<!-- Issues Table -->
<section class="card table-card">
    {% if issues %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Room</th>
                <th>Description</th>
                <th>Reporter</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Assigned To</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for issue in issues %}
            <tr>
                <td><strong>#{{ issue.id }}</strong></td>
                <td>{{ issue.room.building }} {{ issue.room.number }}</td>
                <td class="truncate" title="{{ issue.description }}">
                    {{ issue.description|truncate(50, True, '...') }}
                </td>
                <td>{{ issue.reporter_id or '-' }}</td>
                <td>
                    <span class="status-pill {{ issue.get_status_badge_class() }}">
                        {{ issue.status }}
                    </span>
                </td>
                <td>
                    <span class="priority-badge priority-{{ issue.priority|lower }}">
                        {{ issue.priority }}
                    </span>
                </td>
                <td>
                    {% if issue.assigned_user %}
                        {{ issue.assigned_user.name }}
                    {% else %}
                        <em>Unassigned</em>
                    {% endif %}
                </td>
                <td>{{ issue.created_at.strftime('%Y-%m-%d') }}</td>
                <td>
                    <a href="{{ url_for('issues.issue_detail', issue_id=issue.id) }}" 
                       class="btn secondary small">
                        View
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p class="secondary-text">No issues match your filters.</p>
        <p>
            <a href="{{ url_for('issues.list_issues') }}">Clear filters</a> or 
            <a href="{{ url_for('issues.report_issue') }}">report a new issue</a>.
        </p>
    </div>
    {% endif %}
</section>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
}

.filters-form {
    margin-bottom: 24px;
    padding: 20px;
    background: var(--surface-alt);
    border-radius: 10px;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
}

.filter-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.priority-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.priority-high {
    background: #ffebee;
    color: #c62828;
}

.priority-medium {
    background: #fff3e0;
    color: #e65100;
}

.priority-low {
    background: #e8f5e9;
    color: #2e7d32;
}

.status-progress {
    background: #fff3e0;
    color: #f57c00;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
}

.empty-state p {
    margin: 10px 0;
}
</style>
{% endblock %}